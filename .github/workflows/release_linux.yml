name: Release for linux

permissions:
  contents: read

# Triggered only via workflow_call
on:
  workflow_call:
    inputs:
      tag:
        description: "Tag name to build (e.g., v1.2.3-rc1)"
        required: true
        type: string

jobs:
  # PyInstaller job for both x64 and arm64 binaries
  build-pyinstaller:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      # Set up Python with setup-python action and add it to PATH
      - uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: "3.10"

      # Install Poetry and its dependencies
      - name: Install and configure Poetry
        uses: snok/install-poetry@v1
        with:
          version: "1.8.5"
          virtualenvs-create: true
          virtualenvs-in-project: false
          virtualenvs-path: ~/my-custom-path
          installer-parallel: true

      # Set OS_ARCH env
      - name: Set architecture environment variable
        run: |
          echo "OS_ARCH=x64" >> $GITHUB_ENV; 

      # Cache Poetry dependencies with unique key for each environment and architecture
      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pypoetry
            ~/.cache/pip
            ~/.venv
          key: poetry-${{ env.OS_ARCH }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-${{ env.OS_ARCH }}-

      - name: Install dependencies
        run: poetry install

      - name: Build with PyInstaller
        run: |
          poetry run pyinstaller operate/tendermint.py --onefile
          cp dist/tendermint dist/tendermint_bin

          poetry run pyinstaller --collect-data eth_account --collect-all aea --collect-all autonomy --collect-all operate --collect-all aea_ledger_ethereum --collect-all aea_ledger_cosmos --collect-all aea_ledger_ethereum_flashbots --hidden-import aea_ledger_ethereum --hidden-import aea_ledger_cosmos --hidden-import aea_ledger_ethereum_flashbots operate/pearl.py --onedir --name pearl_${{ env.OS_ARCH }}

      # Package middleware with tar to preserve signatures and extended attributes
      - name: Package middleware with tar
        run: |
          cd dist
          tar -czf pearl_${{ env.OS_ARCH }}.tar.gz pearl_${{ env.OS_ARCH }}/
          cd ..

      - name: Upload middleware artifact
        uses: actions/upload-artifact@v4
        with:
          name: middleware_linux_${{ env.OS_ARCH }}
          path: dist/pearl_${{ env.OS_ARCH }}.tar.gz

      - name: Upload Tendermint artifact
        uses: actions/upload-artifact@v4
        with:
          name: tendermint_linux_${{ env.OS_ARCH }}
          path: dist/tendermint_bin
      

  # Jobs for production, running separately for x64 and arm64
  build-release:
    needs: [build-pyinstaller]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [production]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      - uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: "3.10"

      - name: Add Python to PATH
        run: |
          echo "${{ steps.setup-python.outputs.python-path }}" >> $GITHUB_PATH
      
      - uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"

      # Configure Yarn network settings for timeout, retries, and reduced concurrency
      - name: Configure Yarn network settings
        run: |
              yarn config set network-timeout 60000         # Set network timeout to 1 minute
              yarn config set network-retries 10             # Retry up to 10 times
              yarn config set network-concurrency 2          # Reduce concurrency to 2 connections
    
      # Set OS_ARCH env
      - name: Set architecture environment variable
        run: |
          echo "OS_ARCH=x64" >> $GITHUB_ENV; 
      # Download the appropriate architecture artifact (tar.gz)
      - name: Download middleware binary for architecture
        uses: actions/download-artifact@v4
        with:
          name: middleware_linux_${{ env.OS_ARCH }}
          path: .
      
      # Extract middleware from tar (preserves signatures and extended attributes)
      - name: Extract middleware from tar
        run: |
          tar -xzf pearl_${{ env.OS_ARCH }}.tar.gz
          mkdir -p electron/bins
          mv pearl_${{ env.OS_ARCH }} electron/bins/middleware
      
      - name: Download tendermint binary for architecture
        uses: actions/download-artifact@v4
        with:
          name: tendermint_linux_${{ env.OS_ARCH }}
          path: electron/bins/
      
      # Configure Yarn network settings for timeout, retries, and reduced concurrency
      - name: Configure Yarn network settings
        run: |
            ls electron/bins/

      # Set Tendermint download URL based on architecture
      - name: Set Tendermint download URL
        run: |
          echo "TM_DOWNLOAD_URL=https://github.com/tendermint/tendermint/releases/download/v0.34.19/tendermint_0.34.19_linux_amd64.tar.gz" >> $GITHUB_ENV

      # Cache Tendermint binary
      - name: Cache Tendermint binary
        id: cache-tendermint
        uses: actions/cache@v3
        with:
          path: tendermint_binary/
          key: tendermint-v0.34.19-${{ runner.os }}-${{ env.OS_ARCH }}

      # Download Tendermint (only if not cached)
      - name: Download Tendermint
        if: steps.cache-tendermint.outputs.cache-hit != 'true'
        run: |
          mkdir -p tendermint_binary
          curl -f -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ env.TM_DOWNLOAD_URL }}" -o tendermint_binary/tendermint.tar.gz
          cd tendermint_binary
          tar -xvf tendermint.tar.gz

      # Copy Tendermint to bins
      - name: Install Tendermint binary
        run: |
          cp tendermint_binary/tendermint electron/bins/tendermint
          chmod +x electron/bins/tendermint
      
      
          # Copy tendermint binaries into middleware directory
      - name: Copy tendermint binaries to middleware
        run: |
          cp electron/bins/tendermint electron/bins/middleware/tendermint
          cp electron/bins/tendermint_bin electron/bins/middleware/tendermint_bin
          chmod +x electron/bins/middleware/tendermint
          chmod +x electron/bins/middleware/tendermint_bin


      # Add execution permissions to the binaries
      - name: Add exec permissions
        run: |
          chmod +x electron/bins/tendermint
          chmod +x electron/bins/middleware/pearl_*

      # Cache electron-builder downloads
      - name: Restore electron-builder cache
        id: cache-electron-builder
        uses: actions/cache@v3
        with:
          path: ~/.cache/electron-builder
          key: electron-builder-cache-${{ runner.os }}-${{ env.OS_ARCH }}-${{ matrix.env }}-${{ hashFiles('yarn.lock') }}

      # Cache electron node_modules with unique key for each environment and architecture
      - name: Restore electron node_modules cache
        id: cache-electron-node-modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: electron-node-modules-${{ runner.os }}-${{ env.OS_ARCH }}-${{ matrix.env }}-${{ hashFiles('yarn.lock') }}

      # Install electron dependencies if cache miss
      - name: Install electron dependencies
        if: steps.cache-electron-node-modules.outputs.cache-hit != 'true'
        run: yarn install

      # Cache frontend node_modules with unique key for each environment and architecture
      - name: Restore frontend node_modules cache
        id: cache-frontend-node-modules
        uses: actions/cache@v3
        with:
          path: frontend/node_modules
          key: frontend-node-modules-${{ runner.os }}-${{ env.OS_ARCH }}-${{ matrix.env }}-${{ hashFiles('frontend/yarn.lock') }}

      # Install frontend dependencies if cache miss
      - name: Install frontend dependencies
        if: steps.cache-frontend-node-modules.outputs.cache-hit != 'true'
        run: yarn install:frontend

      # Build frontend for production
      - name: Build frontend for production
        run: yarn build:frontend
        env:
          NODE_ENV: ${{ matrix.env }}          
          IS_STAGING: ${{ github.ref != 'refs/heads/main' && 'true' || 'false' }}
          OPTIMISM_RPC: https://rpc-gate.autonolas.tech/optimism-rpc/
          BASE_RPC: https://rpc-gate.autonolas.tech/base-rpc/
          GNOSIS_RPC: https://rpc-gate.autonolas.tech/gnosis-rpc/
          ETHEREUM_RPC: https://rpc-gate.autonolas.tech/ethereum-rpc/
          MODE_RPC: https://mainnet.mode.network
          CELO_RPC: https://forno.celo.org

      # Run the build and notarization process for production
      - name: Build, notarize, and publish (Production)
        env:
          GH_TOKEN: ${{ secrets.github_token }}
          GITHUB_TOKEN: ${{ secrets.github_token }}
          RELEASE_TAG: ${{ inputs.tag }}
          NODE_ENV: ${{ matrix.env }}
          ARCH: ${{ env.OS_ARCH }}
          ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder
          ELECTRON_BUILDER_DOWNLOAD_RETRY: 10
          ELECTRON_BUILDER_DOWNLOAD_TIMEOUT: 120000
          DEBUG: electron-builder,electron-osx-sign*
          OPTIMISM_RPC: https://rpc-gate.autonolas.tech/optimism-rpc/
          BASE_RPC: https://rpc-gate.autonolas.tech/base-rpc/
          GNOSIS_RPC: https://rpc-gate.autonolas.tech/gnosis-rpc/
          ETHEREUM_RPC: https://rpc-gate.autonolas.tech/ethereum-rpc/
          MODE_RPC: https://mainnet.mode.network
          CELO_RPC: https://forno.celo.org
        run: |
          echo "OPTIMISM_RPC=https://rpc-gate.autonolas.tech/optimism-rpc/" >> .env
          echo "BASE_RPC=https://rpc-gate.autonolas.tech/base-rpc/" >> .env
          echo "GNOSIS_RPC=https://rpc-gate.autonolas.tech/gnosis-rpc/" >> .env
          echo "ETHEREUM_RPC=https://rpc-gate.autonolas.tech/ethereum-rpc/" >> .env
          echo "MODE_RPC=https://mainnet.mode.network" >> .env
          echo "CELO_RPC=https://forno.celo.org" >> .env
          export GITHUB_REF_TYPE="tag"
          export GITHUB_REF_NAME="${RELEASE_TAG}"
          export GITHUB_REF="refs/tags/${RELEASE_TAG}"
          node build-linux.js
