name: Yarn Lock Check

on:
  pull_request:
  push:

jobs:
  check-yarn-lock:
    runs-on: ubuntu-latest
    name: Verify yarn.lock files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Ensure root yarn.lock exists and is valid
        run: |
          if [ ! -f "yarn.lock" ]; then
            echo "Error: Missing root yarn.lock."
            echo "Run 'yarn install' and commit the generated lockfile."
            exit 1
          fi

          if [ ! -s "yarn.lock" ]; then
            echo "Error: Root yarn.lock exists but is empty."
            exit 1
          fi

          yarn install --immutable

      - name: Ensure frontend yarn.lock exists and is valid
        run: |
          if [ ! -f "frontend/yarn.lock" ]; then
            echo "Error: Missing frontend/yarn.lock."
            echo "Run 'cd frontend && yarn install' and commit the generated lockfile."
            exit 1
          fi

          if [ ! -s "frontend/yarn.lock" ]; then
            echo "Error: frontend/yarn.lock exists but is empty."
            exit 1
          fi

          cd frontend
          yarn install --immutable